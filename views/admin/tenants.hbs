{{!< layout/admin}}

<!-- 租户管理页面头部 -->
<div class="page-header">
    <h1>租户管理</h1>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="showCreateTenantModal()">
            <i class="icon-plus"></i> 添加租户
        </button>
    </div>
</div>

<!-- 搜索和过滤 -->
<div class="search-filters">
    <div class="search-box">
        <input type="text" placeholder="搜索租户名称..." id="tenantSearch">
        <button type="button" class="btn btn-secondary">搜索</button>
    </div>
    <div class="filter-group">
        <select id="statusFilter">
            <option value="">全部状态</option>
            <option value="active">激活</option>
            <option value="suspended">暂停</option>
            <option value="expired">过期</option>
        </select>
        <select id="planFilter">
            <option value="">全部套餐</option>
            <option value="free">免费版</option>
            <option value="pro">专业版</option>
            <option value="enterprise">企业版</option>
        </select>
    </div>
</div>

<!-- 租户列表 -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>租户名称</th>
                <th>域名</th>
                <th>套餐</th>
                <th>状态</th>
                <th>用户数</th>
                <th>创建时间</th>
                <th>到期时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {{#each tenants}}
            <tr>
                <td>
                    <div class="tenant-info">
                        <strong>{{this.name}}</strong>
                        <small>{{this.code}}</small>
                    </div>
                </td>
                <td>{{this.domain}}</td>
                <td>
                    <span class="badge badge-{{this.plan}}">
                        {{#if (eq this.plan 'free')}}免费版{{/if}}
                        {{#if (eq this.plan 'pro')}}专业版{{/if}}
                        {{#if (eq this.plan 'enterprise')}}企业版{{/if}}
                    </span>
                </td>
                <td>
                    <span class="status-badge status-{{this.status}}">
                        {{#if (eq this.status 'active')}}激活{{/if}}
                        {{#if (eq this.status 'suspended')}}暂停{{/if}}
                        {{#if (eq this.status 'expired')}}过期{{/if}}
                    </span>
                </td>
                <td>{{this.userCount}}</td>
                <td>{{formatDate this.createdAt}}</td>
                <td>{{formatDate this.expiresAt}}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn btn-sm btn-secondary" onclick="viewTenant('{{this.id}}')">查看</button>
                        <button class="btn btn-sm btn-primary" onclick="editTenant('{{this.id}}')">编辑</button>
                        {{#if (eq this.status 'active')}}
                        <button class="btn btn-sm btn-warning" onclick="suspendTenant('{{this.id}}')">暂停</button>
                        {{else}}
                        <button class="btn btn-sm btn-success" onclick="activateTenant('{{this.id}}')">激活</button>
                        {{/if}}
                        <button class="btn btn-sm btn-danger" onclick="deleteTenant('{{this.id}}')">删除</button>
                    </div>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</div>

<!-- 分页 -->
<div class="pagination">
    <div class="pagination-info">
        显示 {{pagination.start}} - {{pagination.end}} 条，共 {{pagination.total}} 条
    </div>
    <div class="pagination-controls">
        {{#if pagination.hasPrev}}
        <a href="?page={{pagination.prevPage}}" class="btn btn-sm btn-secondary">上一页</a>
        {{/if}}
        
        {{#each pagination.pages}}
        <a href="?page={{this.number}}" class="btn btn-sm {{#if this.current}}btn-primary{{else}}btn-secondary{{/if}}">
            {{this.number}}
        </a>
        {{/each}}
        
        {{#if pagination.hasNext}}
        <a href="?page={{pagination.nextPage}}" class="btn btn-sm btn-secondary">下一页</a>
        {{/if}}
    </div>
</div>

<!-- 创建租户模态框 -->
<div id="createTenantModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>添加租户</h3>
            <button class="modal-close" onclick="hideCreateTenantModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="createTenantForm">
                <div class="form-group">
                    <label for="tenantName">租户名称 *</label>
                    <input type="text" id="tenantName" name="name" required>
                </div>
                <div class="form-group">
                    <label for="tenantCode">租户代码 *</label>
                    <input type="text" id="tenantCode" name="code" required>
                    <small>用于生成子域名，只能包含字母、数字和连字符</small>
                </div>
                <div class="form-group">
                    <label for="tenantDomain">自定义域名</label>
                    <input type="text" id="tenantDomain" name="domain" placeholder="可选，如：company.example.com">
                </div>
                <div class="form-group">
                    <label for="tenantPlan">套餐类型 *</label>
                    <select id="tenantPlan" name="plan" required>
                        <option value="free">免费版</option>
                        <option value="pro">专业版</option>
                        <option value="enterprise">企业版</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tenantAdmin">管理员邮箱 *</label>
                    <input type="email" id="tenantAdmin" name="adminEmail" required>
                </div>
                <div class="form-group">
                    <label for="tenantExpires">到期时间</label>
                    <input type="date" id="tenantExpires" name="expiresAt">
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="hideCreateTenantModal()">取消</button>
            <button type="button" class="btn btn-primary" onclick="createTenant()">创建</button>
        </div>
    </div>
</div>

<script>
// 租户管理相关的JavaScript函数
function showCreateTenantModal() {
    document.getElementById('createTenantModal').style.display = 'block';
}

function hideCreateTenantModal() {
    document.getElementById('createTenantModal').style.display = 'none';
    document.getElementById('createTenantForm').reset();
}

function createTenant() {
    const form = document.getElementById('createTenantForm');
    const formData = new FormData(form);
    
    fetch('/admin/tenants', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(Object.fromEntries(formData))
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideCreateTenantModal();
            location.reload();
        } else {
            alert('创建失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('创建失败，请重试');
    });
}

function viewTenant(tenantId) {
    window.location.href = `/admin/tenants/${tenantId}`;
}

function editTenant(tenantId) {
    window.location.href = `/admin/tenants/${tenantId}/edit`;
}

function suspendTenant(tenantId) {
    if (confirm('确定要暂停这个租户吗？')) {
        fetch(`/admin/tenants/${tenantId}/suspend`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        });
    }
}

function activateTenant(tenantId) {
    if (confirm('确定要激活这个租户吗？')) {
        fetch(`/admin/tenants/${tenantId}/activate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('操作失败：' + data.message);
            }
        });
    }
}

function deleteTenant(tenantId) {
    if (confirm('确定要删除这个租户吗？此操作不可恢复！')) {
        fetch(`/admin/tenants/${tenantId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('删除失败：' + data.message);
            }
        });
    }
}

// 搜索功能
document.getElementById('tenantSearch').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        const searchTerm = this.value;
        const statusFilter = document.getElementById('statusFilter').value;
        const planFilter = document.getElementById('planFilter').value;
        
        const params = new URLSearchParams();
        if (searchTerm) params.set('search', searchTerm);
        if (statusFilter) params.set('status', statusFilter);
        if (planFilter) params.set('plan', planFilter);
        
        window.location.search = params.toString();
    }
});
</script>