{{!< layout/admin}}

<!-- 设置管理页面头部 -->
<div class="page-header">
    <h1>系统设置</h1>
    <div class="page-actions">
        <button class="btn btn-primary" id="saveAllSettings">
            <i class="icon-save"></i> 保存所有设置
        </button>
    </div>
</div>

<div class="settings-container">
    <!-- 设置导航 -->
    <div class="settings-nav">
        <div class="nav-item active" data-tab="general">
            <i class="icon-settings"></i> 基础设置
        </div>
        <div class="nav-item" data-tab="security">
            <i class="icon-shield"></i> 安全设置
        </div>
        <div class="nav-item" data-tab="email">
            <i class="icon-mail"></i> 邮件设置
        </div>
        <div class="nav-item" data-tab="storage">
            <i class="icon-cloud"></i> 存储设置
        </div>
        <div class="nav-item" data-tab="features">
            <i class="icon-toggle"></i> 功能开关
        </div>
        <div class="nav-item" data-tab="backup">
            <i class="icon-backup"></i> 备份设置
        </div>
    </div>

    <!-- 设置内容 -->
    <div class="settings-content">
        <!-- 基础设置 -->
        <div class="settings-tab active" id="general">
            <h2>基础设置</h2>
            <form id="generalForm">
                <div class="form-section">
                    <h3>站点信息</h3>
                    <div class="form-group">
                        <label for="siteName">站点名称</label>
                        <input type="text" id="siteName" name="site_name" value="{{settings.site_name}}">
                    </div>
                    <div class="form-group">
                        <label for="siteDescription">站点描述</label>
                        <textarea id="siteDescription" name="site_description" rows="3">{{settings.site_description}}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="siteLogo">站点Logo URL</label>
                        <input type="url" id="siteLogo" name="site_logo" value="{{settings.site_logo}}">
                    </div>
                </div>

                <div class="form-section">
                    <h3>联系信息</h3>
                    <div class="form-group">
                        <label for="contactEmail">联系邮箱</label>
                        <input type="email" id="contactEmail" name="contact_email" value="{{settings.contact_email}}">
                    </div>
                    <div class="form-group">
                        <label for="supportUrl">支持页面URL</label>
                        <input type="url" id="supportUrl" name="support_url" value="{{settings.support_url}}">
                    </div>
                </div>

                <div class="form-section">
                    <h3>默认设置</h3>
                    <div class="form-group">
                        <label for="defaultLanguage">默认语言</label>
                        <select id="defaultLanguage" name="default_language">
                            <option value="zh-CN" {{#if (eq settings.default_language 'zh-CN')}}selected{{/if}}>简体中文</option>
                            <option value="en-US" {{#if (eq settings.default_language 'en-US')}}selected{{/if}}>English</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="defaultTimezone">默认时区</label>
                        <select id="defaultTimezone" name="default_timezone">
                            <option value="Asia/Shanghai" {{#if (eq settings.default_timezone 'Asia/Shanghai')}}selected{{/if}}>Asia/Shanghai</option>
                            <option value="UTC" {{#if (eq settings.default_timezone 'UTC')}}selected{{/if}}>UTC</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>

        <!-- 安全设置 -->
        <div class="settings-tab" id="security">
            <h2>安全设置</h2>
            <form id="securityForm">
                <div class="form-section">
                    <h3>密码策略</h3>
                    <div class="form-group">
                        <label for="minPasswordLength">最小密码长度</label>
                        <input type="number" id="minPasswordLength" name="password_min_length" value="{{settings.password_min_length}}" min="6" max="20">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="password_require_uppercase" {{#if settings.password_require_uppercase}}checked{{/if}}>
                            要求包含大写字母
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="password_require_numbers" {{#if settings.password_require_numbers}}checked{{/if}}>
                            要求包含数字
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="password_require_symbols" {{#if settings.password_require_symbols}}checked{{/if}}>
                            要求包含特殊字符
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <h3>登录安全</h3>
                    <div class="form-group">
                        <label for="maxLoginAttempts">最大登录尝试次数</label>
                        <input type="number" id="maxLoginAttempts" name="max_login_attempts" value="{{settings.max_login_attempts}}" min="3" max="10">
                    </div>
                    <div class="form-group">
                        <label for="lockoutDuration">账户锁定时间（分钟）</label>
                        <input type="number" id="lockoutDuration" name="lockout_duration" value="{{settings.lockout_duration}}" min="5" max="60">
                    </div>
                    <div class="form-group">
                        <label for="sessionTimeout">会话超时时间（小时）</label>
                        <input type="number" id="sessionTimeout" name="session_timeout" value="{{settings.session_timeout}}" min="1" max="24">
                    </div>
                </div>

                <div class="form-section">
                    <h3>双因素认证</h3>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="mfa_enabled" {{#if settings.mfa_enabled}}checked{{/if}}>
                            启用双因素认证
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="mfa_required_for_admin" {{#if settings.mfa_required_for_admin}}checked{{/if}}>
                            管理员必须启用双因素认证
                        </label>
                    </div>
                </div>
            </form>
        </div>

        <!-- 邮件设置 -->
        <div class="settings-tab" id="email">
            <h2>邮件设置</h2>
            <form id="emailForm">
                <div class="form-section">
                    <h3>SMTP设置</h3>
                    <div class="form-group">
                        <label for="smtpHost">SMTP主机</label>
                        <input type="text" id="smtpHost" name="smtp_host" value="{{settings.smtp_host}}">
                    </div>
                    <div class="form-group">
                        <label for="smtpPort">SMTP端口</label>
                        <input type="number" id="smtpPort" name="smtp_port" value="{{settings.smtp_port}}">
                    </div>
                    <div class="form-group">
                        <label for="smtpUser">SMTP用户名</label>
                        <input type="text" id="smtpUser" name="smtp_user" value="{{settings.smtp_user}}">
                    </div>
                    <div class="form-group">
                        <label for="smtpPassword">SMTP密码</label>
                        <input type="password" id="smtpPassword" name="smtp_password" placeholder="****">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="smtp_secure" {{#if settings.smtp_secure}}checked{{/if}}>
                            使用SSL/TLS
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <h3>邮件发送设置</h3>
                    <div class="form-group">
                        <label for="fromEmail">发件人邮箱</label>
                        <input type="email" id="fromEmail" name="from_email" value="{{settings.from_email}}">
                    </div>
                    <div class="form-group">
                        <label for="fromName">发件人名称</label>
                        <input type="text" id="fromName" name="from_name" value="{{settings.from_name}}">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="testEmail()">测试邮件发送</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- 存储设置 -->
        <div class="settings-tab" id="storage">
            <h2>存储设置</h2>
            <form id="storageForm">
                <div class="form-section">
                    <h3>文件存储</h3>
                    <div class="form-group">
                        <label for="storageType">存储类型</label>
                        <select id="storageType" name="storage_type">
                            <option value="local" {{#if (eq settings.storage_type 'local')}}selected{{/if}}>本地存储</option>
                            <option value="s3" {{#if (eq settings.storage_type 's3')}}selected{{/if}}>Amazon S3</option>
                            <option value="oss" {{#if (eq settings.storage_type 'oss')}}selected{{/if}}>阿里云OSS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="maxFileSize">最大文件大小（MB）</label>
                        <input type="number" id="maxFileSize" name="max_file_size" value="{{settings.max_file_size}}" min="1" max="100">
                    </div>
                    <div class="form-group">
                        <label for="allowedFileTypes">允许的文件类型</label>
                        <input type="text" id="allowedFileTypes" name="allowed_file_types" value="{{settings.allowed_file_types}}" placeholder="jpg,png,pdf,doc">
                    </div>
                </div>

                <div class="form-section storage-config" id="s3Config" style="display: none;">
                    <h3>Amazon S3配置</h3>
                    <div class="form-group">
                        <label for="s3Bucket">S3存储桶名称</label>
                        <input type="text" id="s3Bucket" name="s3_bucket" value="{{settings.s3_bucket}}">
                    </div>
                    <div class="form-group">
                        <label for="s3Region">S3区域</label>
                        <input type="text" id="s3Region" name="s3_region" value="{{settings.s3_region}}">
                    </div>
                    <div class="form-group">
                        <label for="s3AccessKey">访问密钥ID</label>
                        <input type="text" id="s3AccessKey" name="s3_access_key" value="{{settings.s3_access_key}}">
                    </div>
                    <div class="form-group">
                        <label for="s3SecretKey">秘密访问密钥</label>
                        <input type="password" id="s3SecretKey" name="s3_secret_key" placeholder="****">
                    </div>
                </div>
            </form>
        </div>

        <!-- 功能开关 -->
        <div class="settings-tab" id="features">
            <h2>功能开关</h2>
            <form id="featuresForm">
                <div class="form-section">
                    <h3>用户功能</h3>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="allow_user_registration" {{#if settings.allow_user_registration}}checked{{/if}}>
                            <span class="switch"></span>
                            允许用户注册
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="require_email_verification" {{#if settings.require_email_verification}}checked{{/if}}>
                            <span class="switch"></span>
                            要求邮箱验证
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="allow_password_reset" {{#if settings.allow_password_reset}}checked{{/if}}>
                            <span class="switch"></span>
                            允许密码重置
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <h3>系统功能</h3>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="maintenance_mode" {{#if settings.maintenance_mode}}checked{{/if}}>
                            <span class="switch"></span>
                            维护模式
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="debug_mode" {{#if settings.debug_mode}}checked{{/if}}>
                            <span class="switch"></span>
                            调试模式
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="analytics_enabled" {{#if settings.analytics_enabled}}checked{{/if}}>
                            <span class="switch"></span>
                            启用分析统计
                        </label>
                    </div>
                </div>
            </form>
        </div>

        <!-- 备份设置 -->
        <div class="settings-tab" id="backup">
            <h2>备份设置</h2>
            <form id="backupForm">
                <div class="form-section">
                    <h3>自动备份</h3>
                    <div class="form-group">
                        <label class="switch-label">
                            <input type="checkbox" name="auto_backup_enabled" {{#if settings.auto_backup_enabled}}checked{{/if}}>
                            <span class="switch"></span>
                            启用自动备份
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="backupFrequency">备份频率</label>
                        <select id="backupFrequency" name="backup_frequency">
                            <option value="daily" {{#if (eq settings.backup_frequency 'daily')}}selected{{/if}}>每日</option>
                            <option value="weekly" {{#if (eq settings.backup_frequency 'weekly')}}selected{{/if}}>每周</option>
                            <option value="monthly" {{#if (eq settings.backup_frequency 'monthly')}}selected{{/if}}>每月</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="backupRetention">备份保留天数</label>
                        <input type="number" id="backupRetention" name="backup_retention" value="{{settings.backup_retention}}" min="7" max="365">
                    </div>
                </div>

                <div class="form-section">
                    <h3>备份操作</h3>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="createBackup()">立即备份</button>
                        <button type="button" class="btn btn-secondary" onclick="viewBackups()">查看备份列表</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// 设置管理相关的JavaScript函数
document.addEventListener('DOMContentLoaded', function() {
    // 标签页切换
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const tabName = this.dataset.tab;
            
            // 更新导航状态
            document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            
            // 切换内容
            document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
        });
    });

    // 存储类型切换
    document.getElementById('storageType').addEventListener('change', function() {
        const storageType = this.value;
        document.querySelectorAll('.storage-config').forEach(config => {
            config.style.display = 'none';
        });
        
        if (storageType !== 'local') {
            const configDiv = document.getElementById(storageType + 'Config');
            if (configDiv) {
                configDiv.style.display = 'block';
            }
        }
    });

    // 初始化存储配置显示
    const currentStorageType = document.getElementById('storageType').value;
    if (currentStorageType !== 'local') {
        const configDiv = document.getElementById(currentStorageType + 'Config');
        if (configDiv) {
            configDiv.style.display = 'block';
        }
    }
});

// 保存所有设置
document.getElementById('saveAllSettings').addEventListener('click', function() {
    const forms = ['generalForm', 'securityForm', 'emailForm', 'storageForm', 'featuresForm', 'backupForm'];
    const allData = {};

    forms.forEach(formId => {
        const form = document.getElementById(formId);
        const formData = new FormData(form);
        
        formData.forEach((value, key) => {
            if (form.querySelector(`[name="${key}"]`).type === 'checkbox') {
                allData[key] = form.querySelector(`[name="${key}"]`).checked;
            } else {
                allData[key] = value;
            }
        });
    });

    fetch('/admin/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(allData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('设置保存成功');
        } else {
            alert('保存失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('保存失败，请重试');
    });
});

// 测试邮件发送
function testEmail() {
    const emailData = {
        smtp_host: document.getElementById('smtpHost').value,
        smtp_port: document.getElementById('smtpPort').value,
        smtp_user: document.getElementById('smtpUser').value,
        smtp_password: document.getElementById('smtpPassword').value,
        smtp_secure: document.querySelector('[name="smtp_secure"]').checked,
        from_email: document.getElementById('fromEmail').value,
        from_name: document.getElementById('fromName').value
    };

    fetch('/admin/settings/test-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(emailData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('测试邮件发送成功');
        } else {
            alert('测试失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('测试失败，请重试');
    });
}

// 创建备份
function createBackup() {
    fetch('/admin/settings/backup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('备份创建成功');
        } else {
            alert('备份失败：' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('备份失败，请重试');
    });
}

// 查看备份列表
function viewBackups() {
    window.location.href = '/admin/backups';
}
</script>